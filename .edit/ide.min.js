function DroidScriptApp(n){this.folder=n;this.editorFiles=[];this.activeEditorFile=null;this.mainEditorFile=null;this.eventHandlers={fileAdded:[],fileRemoved:[],fileRenamed:[]}}function DroidScriptAppFile(n){this.filename=n;var t=n.split(".").slice(0,-1);this.displayName=t.join(".");this.functions=[];this.session=null;this.modified=!1;this.tabId=uniqueTabIdCounter++;this.errorMarkers=[];this.canDelete=!1}function AppService(){function r(n,t){var r=t||window;i.appChanged.forEach(function(t){t.call(r,n)})}var t="",n={},i={appChanged:[]};this.getOpenApp=function(){return t==""?null:n[t]};this.setOpenApp=function(n){n==null&&(t="");t=n.getName();r(this.getOpenApp(),this)};this.getApp=function(t){return n[t]};this.removeApp=function(t){delete n[t]};this.addApp=function(t){n[t.getName()]=t};this.clear=function(){n={}};this.on=function(n,t){i[n].push(t)};this.off=function(n,t){i[n]=i[n].filter(function(n){if(n!==t)return n})}}function IDEConfig(){this.config={ipAddress:"",zoom:1,editor:{fontSize:14,useBehaviours:!1,useWorker:!1}}}function ElementFader(n){this.element=n;var t=0,i=null,r=null;this.show=function(){if(t++==0){clearTimeout(r);var n=this;i=setTimeout(function(){n.element.fadeIn()},250)}};this.hide=function(){if(--t==0){clearTimeout(i);var n=this;r=setTimeout(function(){n.element.fadeOut()},250)}}}function Log(n,t){this.list=n;this.filter=t}function TernService(){function e(t){var u=n.editor.ternServer,f,i;for(f in u.docs)u.delDoc(f);if(t!==null){for(i=0;i<t.editorFiles.length;++i)r(t.editorFiles[i]);t.on("fileAdded",o);t.on("fileRemoved",s)}}function r(t){t.getType().toLowerCase().indexOf("js")>-1&&n.editor.ternServer.addDoc(t.filename,t.session)}function o(n){r(n)}function s(t){var i=n.editor.ternServer;i.delDoc(t.filename)}function h(n){var t=location.protocol==="http:";return new Promise(function(i){n.setOptions({enableTern:{defs:[],useWorker:t,switchToDoc:function(n,t){Debug.Log("switchToDoc called but not defined. name="+n+"; start=",t)},startedCb:function(){Debug.Log("editor.ternServer:",n.ternServer);i()}},enableSnippets:!1,enableBasicAutocompletion:!1})})}function c(n){var r=window.prompt;window.prompt=function(){};a().then(function(r){var o=n.ternServer.server,a=i("Obj",Obj.toString()),h,c,s,u,f,e,v;for(o.addFile("Obj",a),h=i("SObj",SObj.toString()),o.addFile("SObj",h),c=l(r),s=0;s<c.length;++s)try{u=c[s];f=i(u,window[u].toString());f.indexOf("new SObj")>-1?(e={},e[" "+u+"("]=" "+u+"__SObj__(",e[" SObj("]=" "+u+"(",f=t(h+"\n"+f,e)):f.indexOf("new Obj")>-1&&(e={},e[" "+u+"("]=" "+u+"__Obj__(",e[" Obj("]=" "+u+"(",f=t(a+"\n"+f,e));o.addFile(u,f)}catch(y){Debug.Log(key+": "+y)}v="app = new App();";o.addFile("Global",v)},function(n){Debug.Log(n)}).catch(function(n){Debug.Log(n)}).then(function(){window.prompt=r})}function l(n){var u=[],t,i,r;try{for(t=/function\s+(.+)\s?\(/g;(i=t.exec(n))!==null;)i.index===t.lastIndex&&t.lastIndex++,r=i[1],r.charAt(0)!=="_"&&ds_excludedTypes.indexOf(r)===-1&&u.push(i[1])}catch(f){Debug.Log("getDroidScriptTypeList: "+f)}return u}function t(n,t){var i=Object.keys(t).join("|"),r;return i=i.replace(/\(/g,"\\("),r=new RegExp(i,"g"),n.replace(r,function(n){return t[n]})}function i(n,i){var r,f,u,e,o;if(ds_excludedProperties.hasOwnProperty(n)){r=ds_excludedProperties[n];f={};for(u in r)e="this."+r[u],o="___ex."+r[u],f[e]=o,e="obj."+r[u],o="___ex."+r[u],f[e]=o;return t(i,f)}return i}function a(){return NetUtils.ajaxGet({url:NetUtils.getServerUrl(".edit/app.js")})}function v(t){var i=n.editor.ternServer;if(i.closeAllTips(),t.oldSession!==null&&t.oldSession.selection.off("changeCursor",f),t.session!==null)t.session.selection.on("changeCursor",f)}function y(){var t=n.editor.ternServer;t.closeAllTips()}function f(){clearTimeout(u);u=setTimeout(function(){n.editor.ternServer.updateArgHints(n.editor)},10)}var n=this,u;this.editor=null;this.changeArgHintsHandlers=[];this.init=function(n,t){var i,r;this.editor=n;ace.config.loadModule("ace/ext/tern",function(){h(n).then(function(){c(n)})});for(i in tern_commands)r=tern_commands[i],n.commands.addCommand(r);t.on("appChanged",e);n.on("changeSession",v);n.on("blur",y)}}function ChromeApp(){this.broadcastSocket=null;this.initialised=!1;this.deviceId=""}function UDPSocket(){this.socketId=-1}function sim_ajaxGet(n,t,i,r){n=="SmartScript"?sim_smartScript(t,i,r):alert("Unknown simType!")}function sim_smartScript(n,t){var o,f,s,u;if(n.url.indexOf("/ide?")>-1){var e=n.url.split("?"),r=e[1].split("&"),i=getParam(r,"cmd");i=="getinfo"?(o=null,t('{"status":"ok", "lastprog":"'+o+'", "appname":"DroidScript"}')):i=="getsamples"?t('{ "samples":"demo1"}'):i=="list"?(f=getParam(r,"dir"),f?t('{ "list":["'+f+'.js"] }'):t('{ "list":["test"] }')):i=="add"?(u=getParam(r,"prog"),s=getParam(r,"type"),document.ide.add(u,s),t('{"status":"ok"}')):i=="run"?(u=getParam(r,"prog"),document.ide.run(u)):i=="stop"?(u=getParam(r,"prog"),document.ide.stop(u),t('{"status":"ok"}')):(alert("Unknown IDE command: "+i),t('{"status":"unknown command"}'))}else{var e=n.url.split("8088/"),h=e[1],c=document.ide.get(h);t(c)}}function getParam(n,t){for(var r,i=0;i<n.length;i++)if(r=n[i].split("="),r.length>1&&r[0]==t)return r[1];return null}function loadHomePage(){$("#homeView").attr("src","http://www.androidscript.org/Home/home.html?demos=true")}function onReceiveMessage(n){var t,i;n.origin==="http://www.androidscript.org"&&(n.data=="homePageReady"?(clearTimeout(homePageErrorTimeout),$("#homeView").css("width","100%"),$("#homeView").css("height","100%"),$("#homeErrorPage").hide()):(t=n.data.split("|"),t.length==2&&t[0]==="downloadspk"&&(i=decodeURIComponent(t[1]).replace(/^.*[\\\/]/,""),$("#okCancelDialogOkButton").off("click").click(function(){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=downloadspk&url="+encodeURIComponent(t[1]))})}),$("#okCancelDialogHeader").text("Install SPK"),$("#okCancelDialogMessage").text("Click OK to download "+i+" and follow the instructions on your Android device."),$("#okCancelDialog").modal("show"))))}function onEditorResize(){var n=$("#editorTabs").outerHeight(!0),t=$("#editorToolBar").outerHeight(!0);$("#editor").css("top",n+t);$("#editorTabs").data("tabdrop")!=null&&$("#editorTabs").data("tabdrop").layout()}function initIDE(){editor=ace.edit("editor");editor.setTheme("ace/theme/textmate");editor.setFontSize(ideConfig.getFontSize());editor.setBehavioursEnabled(ideConfig.getUseBehaviours());editor.$blockScrolling=Infinity;editor.on("changeSession",function(n){if(n.session){n.session.on("tokenizerUpdate",onTokensChanged);n.session.on("change",onDocumentChanged);var t={first:0,last:n.session.getLength()};onTokensChanged({data:t});applyConfigForSession(n.session)}n.oldSession&&(n.oldSession.removeEventListener("tokenizerUpdate",onTokensChanged),n.oldSession.removeEventListener("change",onDocumentChanged))});sampleEditor=ace.edit("sampleEditor");sampleEditor.setTheme("ace/theme/textmate");sampleEditor.getSession().setMode("ace/mode/javascript");sampleEditor.setReadOnly(!0);sampleEditor.renderer.setShowGutter(!1);sampleEditor.setHighlightActiveLine(!1);sampleEditor.setFontSize(ideConfig.getFontSize());sampleEditor.getSession().setUseWorker(!1)}function updateTooltips(){$("[data-toggle=tooltip]").tooltip({container:"body"})}function showEditorError(n){var i;n=n.replace("Script Error: ","");var f=n.split("|"),r=f[1]-1,e=decodeURIComponent(f[2].replace(/^.*[\\\/]/,"")),t=null,u=appService.getOpenApp();for(i=0;i<u.getEditorFileCount();++i)if(u.getEditorFile(i).filename==e){t=u.getEditorFile(i);break}t&&loadEditorFile(t,u).then(function(){var n=t.session.getAnnotations(),i;n.push({row:r,column:0,text:f[0],type:"error"});t.session.setAnnotations(n);i=new Range(r,0,r,Infinity);t.errorMarkers.push(t.session.addMarker(i,"ace_error-marker","line"));$('#editorTabs a[href="'+t.tabId+'"]').tab("show");editor.scrollToLine(r,!0,!0)})}function onExpand(){$("#leftPanel").hasClass("span6")?($("#leftPanel").removeClass("span6"),$("#leftPanel").addClass("span8"),$("#rightPanel").removeClass("span6"),$("#rightPanel").addClass("span4"),$("#expBtn img").attr("src",Resources.COLLAPSE),$("#expBtn").attr("title","Collapse Editor").tooltip("fixTitle").tooltip("show")):($("#leftPanel").removeClass("span8"),$("#leftPanel").addClass("span6"),$("#rightPanel").removeClass("span4"),$("#rightPanel").addClass("span6"),$("#expBtn i").removeClass(),$("#expBtn i").addClass(),$("#expBtn img").attr("src",Resources.EXPAND),$("#expBtn").attr("title","Expand Editor").tooltip("fixTitle").tooltip("show"));editor.resize();$("#editorTabs").data("tabdrop").layout()}function onDebugFilter(){var n=$("#debugFilter").val().trim(),t;n.length==0?$("#debugList li").each(function(){$(this).show()}):(n=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),t=new RegExp(n,"i"),$("#debugList li").each(function(){t.test($(this).text())?$(this).show():$(this).hide()}));Logger.scrollToBottom()}function webSocketIsConnected(){return webSocket!=null&&(webSocket.readyState==0||webSocket.readyState==1)}function openWebSocket(){webSocketIsConnected()||(window.WebSocket?(webSocket=new WebSocket(NetUtils.getServerWSUrl("")),webSocket.onopen=webSocket_onopen,webSocket.onmessage=webSocket_onmessage,webSocket.onclose=webSocket_onclose,webSocket.onerror=webSocket_onerror):Logger.error("WebSocket not supported by this browser, the debug window will not be available."))}function webSocket_onopen(){Logger.message("[Connected]");$("#ideConnected").show();$("#ideDisconnected").hide();var n="<i class='fa fa-wifi connected-green' style='font-size:20px'><\/i> Connected to "+serverInfo.devicename;$("#ideConnected").popover("destroy");$("#ideConnected").popover({html:!0,placement:"left",trigger:"hover",content:n});$("#ideConnected").popover("show");setTimeout(function(){$("#ideConnected").popover("hide")},4e3);webSocket.send("debug");webSocketKeepAliveTimer=setInterval(function(){Debug.Log("sending keepalive");webSocket.send("keepalive")},5e3)}function webSocket_onmessage(n){var t=n.data;t.indexOf("Script Error")>-1?(Logger.error(t),showEditorError(t)):t.indexOf("WARNING")>-1?Logger.warning(t):t.indexOf("svc:")>-1?Logger.service(t):Logger.message(t)}function webSocket_onclose(){function n(t){if(t==4){onRequestError();return}connect(serverIPAddress).then(function(){refreshAppsList()},function(i){i=="PasswordError"?(serverPass="",n(++t)):onRequestError()})}Logger.message("[Disconnected]");$("#ideDisconnected").show();$("#ideConnected").hide();$("#ideDisconnected").popover("destroy");$("#ideDisconnected").popover({html:!0,placement:"left",trigger:"hover",content:"Disconnected. Click <i class='fa fa-wifi disconnected-red' style='font-size:20px'><\/i> to reconnect"});$("#ideDisconnected").popover("show");setTimeout(function(){$("#ideDisconnected").popover("hide")},4e3);$("#ideDisconnected").off("click").on("click",function(){n(0)});clearInterval(webSocketKeepAliveTimer);webSocketKeepAliveTimer=null}function webSocket_onerror(n){Logger.error("Connection Error: "+n.data)}function onConnect(){$("#connectError").hide();$("#passwordError").hide();$("#connectButton").hide();connect($("#serverIPAddress").val()).then(function(n){$("#connectDialog").modal("hide");connected(n)},function(n){$("#connectDialog").modal("show");n=="PasswordError"?$("#passwordError").fadeIn():$("#connectError").fadeIn();$("#connectButton").fadeIn()})}function connect(n){return new Promise(function(t,i){webSocketIsConnected()?t(serverInfo):(serverIPAddress=n.split(":")[0],getServerInfo().then(function(n){$("#connectDialog").modal("hide");serverInfo=n;serverInfo.usepass?loginWithPassword(serverPass).then(function(){openWebSocket();t(serverInfo)},function(){i("PasswordError")}):(serverPass="",openWebSocket(),t(serverInfo))},function(){i("ConnectError")}))})}function getServerInfo(){return new Promise(function(n,t){NetUtils.ajaxGetNoConnect({url:NetUtils.getServerUrl("ide?cmd=getinfo"),timeout:5e3}).then(function(t){var i=JSON.parse(t);typeof i.usepass=="undefined"&&(i.usepass=!1);typeof i.devicename=="undefined"&&(i.devicename=serverIPAddress);n(i)},t)})}function loginWithPassword(n){return new Promise(function(t,i){function r(n){n.length>0?NetUtils.ajaxGetNoConnect({url:NetUtils.getServerUrl("ide?cmd=login&pass="+n),timeout:5e3}).then(function(r){var u=JSON.parse(r);u.status=="ok"?(serverPass=n,t()):i(u.status)},i):i()}if(typeof n=="undefined"||n=="")if($("#passwordDialogOkButton").off("click").click(function(){$("#passwordDialogError").hide();var n=$("#passwordDialogPassword").val();n=btoa(n);r(n)}),$("#passwordDialogCancelButton").off("click").click(function(){$("#passwordDialogError").hide();i("PasswordCanceled")}),$("#passwordDialogPassword").val(""),$("#passwordDialog").is(":visible")){$("#passwordDialog").on("hidden",function(){$("#passwordDialog").off("hidden");$("#passwordDialog").modal("show")});$("#passwordDialog").modal("hide")}else $("#passwordDialog").modal("show");else r(n)})}function connected(n){var t=n.appname;$("#ideTitle").append(" "+t);document.title=t;ternService=new TernService;ternService.init(editor,appService);refreshAppsList().then(function(){var i,t;populateSampleContents();chromeApp.isInitialised()?(i=$("<webview id='docs' src='' width='100%' height='100%'><\/webview>"),i.appendTo(".docsWrapper"),typeof n.macaddress!="undefined"&&chromeApp.setDeviceId(n.macaddress)):(i=$("<iframe id='docs' src='' frameborder='0'><\/iframe>"),i.appendTo(".docsWrapper"));ideConfig.setIPAddress(serverIPAddress);$("#docs").attr("src",NetUtils.getServerUrl(".edit/docs/Docs.htm"));typeof n.premium!="undefined"&&n.premium&&enablePremium();t=n.lastprog;t!="null"&&appService.getApp(t)!=null?(Logger.message("Opening most recently edited app - '"+t+"'...."),openApp(appService.getApp(t))):$('#leftPanelTabs a[href="#appsTab"]').tab("show")})}function enablePremium(){var t,n;$("#leftPanelTabs").append($('<li data-toggle="tooltip" data-placement="right" title="Device Browser"><a class="no-min-width" href="#browserTab" data-toggle="tab" style="min-width:0px"><i class="fa fa-mobile file-browser-tab"><\/i><\/a><\/li>'));$("#leftPanel .tab-content").append($('<div class="tab-pane" id="browserTab" style="height: 100%;"><div class="browserWrapper"><\/div><\/div>'));chromeApp.isInitialised()?(n=$("<webview id='browser' src='' width='100%' height='100%'><\/webview>"),n.appendTo(".browserWrapper"),t=document.getElementById("browser"),t.addEventListener("newwindow",function(n){n.preventDefault();window.open(event.targetUrl)})):(n=$("<iframe id='browser' src='' frameborder='0'><\/iframe>"),n.appendTo(".browserWrapper"));$("#browser").attr("src",NetUtils.getUrl("http",8889)+"/browse")}function onRequestError(){$("#errorDialog").modal("show")}function onUploadError(){$("#errorDialog").modal("show")}function refreshAssets(n){var t,i,r,u;typeof n=="undefined"&&(n="Img,Snd,Html,Misc");n.indexOf("Img")!=-1&&(t=appService.getOpenApp().folder+"/Img",NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=list&dir="+encodeURIComponent(t))}).then(function(n){var i=sortList(JSON.parse(n).list);populateAssets(i,$("#imageAssetsList"),t,Resources.ASSET_IMG);$("#imageAssetsList").find("img").each(function(n){loadExternalImage(NetUtils.getServerUrl(t+"/")+i[n],$(this),Resources.ASSET_IMG)})}));n.indexOf("Snd")!=-1&&(i=appService.getOpenApp().folder+"/Snd",NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=list&dir="+encodeURIComponent(i))}).then(function(n){var t=sortList(JSON.parse(n).list);populateAssets(t,$("#soundAssetsList"),i,Resources.ASSET_SND)}));n.indexOf("Html")!=-1&&(r=appService.getOpenApp().folder+"/Html",NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=list&dir="+encodeURIComponent(r))}).then(function(n){var t=sortList(JSON.parse(n).list);populateAssets(t,$("#htmlAssetsList"),r,Resources.ASSET_HTML)}));n.indexOf("Misc")!=-1&&(u=appService.getOpenApp().folder+"/Misc",NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=list&dir="+encodeURIComponent(u))}).then(function(n){var t=sortList(JSON.parse(n).list);populateAssets(t,$("#miscAssetsList"),u,Resources.ASSET_MISC)}))}function populateAssets(n,t,i,r){var u,e,f;for(t.empty(),u=0;u<n.length;u++)n[u].indexOf(".nomedia")==-1&&(e="",e+='<li>\n<div class="thumbnail">\n<div style="height: 64px; text-align: center; vertical-align: middle;">\n<img alt="" src="'+r+'" style="width: 64px; max-height: 64px"/>\n<\/div>\n<div class="caption">\n<div class="well thumbnailFilename">'+n[u]+'<\/div>\n<p class="thumbnailButtons">\n<a id="renameAssetButton" href="#" class="btn btn-mini btn-flat btn-noborder" data-toggle="tooltip" title="Rename">\n<i class="icon-edit"><\/i>\n<\/a>\n<a id="deleteAssetButton" href="#" class="btn btn-mini btn-flat btn-noborder" data-toggle="tooltip" title="Delete">\n<i class="icon-trash"><\/i>\n<\/a>\n<\/p>\n<\/div>\n<\/div>\n<\/li>\n',f=$(e),f.data("assetFile",n[u]),f.data("assetDir",i),t.append(f));updateTooltips()}function assetFileUploadChanged(n,t,i){if($("input[id="+n+"]").val()!=""){$("#"+n).attr("name",appService.getOpenApp().folder+i);var r=new FormData($("#"+t)[0]);$.ajax({url:NetUtils.getServerUrl("uploader"),data:r,processData:!1,contentType:!1,type:"POST"}).done(function(){refreshAssets(i)}).fail(function(n,t,i){onUploadError(n,t,i)});$("input[id="+n+"]").val("")}}function handleAssetDragOver(n){n=n.originalEvent;n.stopPropagation&&n.stopPropagation();n.preventDefault&&n.preventDefault();n.dataTransfer.dropEffect="copy"}function handleAssetDragEnter(n){n=n.originalEvent;dragOverStack.push(n.target);var t=$(n.target).closest(".asset-drop-target");t!==null&&t.addClass("drop-target-highlight")}function handleAssetDragLeave(n){if(n=n.originalEvent,dragOverStack.pop(),dragOverStack.length===0){var t=$(n.target).closest(".asset-drop-target");t!==null&&t.removeClass("drop-target-highlight")}}function handleAssetDragEnd(n){n=n.originalEvent;dragOverStack=[];var t=$(n.target).closest(".asset-drop-target");t!==null&&t.removeClass("drop-target-highlight")}function handleAssetDrop(n){var t,i,u,r,f;if(n=n.originalEvent,n.stopPropagation&&n.stopPropagation(),n.preventDefault&&n.preventDefault(),dragOverStack=[],t=$(n.target).closest(".asset-drop-target"),t!==null&&t.removeClass("drop-target-highlight"),appService.getOpenApp()!=null)for(i="",t.hasClass("img-asset-group")?i="/Img":t.hasClass("snd-asset-group")?i="/Snd":t.hasClass("html-asset-group")?i="/Html":t.hasClass("misc-asset-group")&&(i="/Misc"),u=n.dataTransfer.files,r=0;r<u.length;++r)u[r].type!==""&&(f=new FileReader,f.source=u[r],f.onload=function(n){var t=n.target.source,r=appService.getOpenApp().folder+i,u=n.target.result;createFile(r,t.name,u,t.type).then(function(){refreshAssets(i)},onUploadError)},f.onerror=function(){onUploadError()},f.readAsArrayBuffer(u[r]))}function onSave(){save(appService.getOpenApp().activeEditorFile).then(null,onRequestError)}function save(n){return new Promise(function(t,i){if(n.session&&n.modified){var r=appService.getOpenApp();createFile(r.folder,n.filename,n.session.getValue()).then(function(){clearAnnotations(r);setModified(n,!1);t()},i)}else t()})}function clearAnnotations(n){for(var t,r,i=0;i<n.getEditorFileCount();++i){if(t=n.getEditorFile(i),t.session){for(t.session.clearAnnotations(),r=0;r<t.errorMarkers.length;++r)t.session.removeMarker(t.errorMarkers[r]);t.session.$worker&&t.session.$worker.call("onUpdate")}t.errorMarkers=[]}}function saveAll(){return new Promise(function(n,t){for(var r=[],u=appService.getOpenApp(),i=0;i<u.getEditorFileCount();++i)r.push(save(u.getEditorFile(i)));Promise.all(r).then(n,t)})}function onRun(){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=stop")}).then(function(){return saveAll()}).then(function(){Logger.clear();NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=run&prog="+encodeURIComponent(appService.getOpenApp().getName()))})},function(){onRequestError()})}function onStop(){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=stop")}).then(null,onRequestError)}function addSampleButton(n,t,i){var u='<div><a id=\'sampleButton\' class="btn btn-flat" style="width: 100%; padding: 0px"><p style="margin: 5px; text-align: left; font-size: 16px"><b>'+n+'<\/b><\/p><p style="margin: 5px; text-align: left;">'+t+"<\/p><\/a><\/div>",r=$(u);r.data("title",n);r.data("type",i);$("#samplesContentList").append(r)}function populateSampleContents(){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=getsamples")}).then(function(n){for(var t,u=JSON.parse(n).samples,r=u.split(","),i=0;i<r.length;++i)t=r[i].split(":"),addSampleButton(t[0],t[1],t[2])})}function runSample(){var n=currentSample.split(" ").join("_");NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=sample&name="+n)})}function onSampleFilter(){var n=$("#sampleFilter").val().trim(),t;n.length==0?$("#samplesContentList").children("div").each(function(){$(this).show()}):(n=n.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),t=new RegExp(n,"i"),$("#samplesContentList").children("div").each(function(){var n=!1;$(this).find("p").each(function(){n|=t.test($(this).text())});n?$(this).show():$(this).hide()}))}function appendAppToAppsList(n){var i='<li style="position: relative;" class="app-thumbnail">\n<div id="openAppButton" class="thumbnail" style="border: 0px; box-shadow: none;">\n<div style="text-align: center; vertical-align: middle;"><img class="app-image">\n<\/div><div><p class="appFilename">'+n.getName()+'<\/p>\n<\/div><\/div>\n<div id="appButtons" style="opacity: 0;">\n<div style="position: absolute; top: 0px; margin: 5px 10px;">\n<a id="renameAppButton" class="btn btn-mini btn-flat btn-noborder" data-toggle="tooltip" title="Rename"><i class="icon-edit"><\/i><\/a>\n<\/div>\n<div style="position: absolute; top: 0px; right: 0px; margin: 5px 10px;">\n<a id="deleteAppButton" class="btn btn-mini btn-flat btn-noborder" data-toggle="tooltip" title="Delete"><i class="icon-trash"><\/i><\/a>\n<\/div>\n<\/div>\n<\/li>\n',t=$(i);t.data("appName",n.getName());t.hover(function(){$(this).find("img").animate({opacity:"1.0"},"fast");$(this).find("div#appButtons").animate({opacity:"1.0"},"fast")},function(){$(this).find("img").animate({opacity:"0.7"},"fast");$(this).find("div#appButtons").animate({opacity:"0.0"},"fast")});$("#appsList").append(t);loadExternalImage(NetUtils.getServerUrl(n.getIconPath()),t.find(".app-image"),Resources.APP_ICON)}function refreshAppsList(){return new Promise(function(n,t){var i=appService.getOpenApp();NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=list&dir=")}).then(function(t){var o=JSON.parse(t).list,r,u,e,f;for(appService.clear(),$("#appsList").empty(),r="",r='<li class="app-thumbnail" id="newApp">\n<div class="thumbnail" style="border: 0px; box-shadow: none;">\n<div style="text-align: center; vertical-align: middle;"><img class="app-image" src="resources/droidscript_app_new_js.png">\n<\/div><div><p class="appFilename">New App...<\/p>\n<\/div><\/div>\n<\/li>\n',u=$(r),$("#appsList").append(u),r='<li class="app-thumbnail" id="newHtmlApp">\n<div class="thumbnail" style="border: 0px; box-shadow: none;">\n<div style="text-align: center; vertical-align: middle;"><img class="app-image" src="resources/droidscript_app_new_html.png">\n<\/div><div><p class="appFilename">New Html App...<\/p>\n<\/div><\/div>\n<\/li>\n',u=$(r),$("#appsList").append(u),e=[],f=0;f<o.length;f++)e.push(getDroidScriptApp(o[f]));Promise.all(e).then(function(t){for(var r=0;r<t.length;++r)t[r]&&(appService.addApp(t[r]),appendAppToAppsList(t[r]));i!=null&&(appService.removeApp(i.getName()),appService.addApp(i));n()},onRequestError)},t)})}function sortAppList(){var i=$("#appsList #newApp"),r=$("#appsList #newHtmlApp"),t,n;i.remove();r.remove();t=$("#appsList li").get();t.sort(function(n,t){var i=$(n).data("appName"),r=$(t).data("appName");return i.toLowerCase()<r.toLowerCase()?-1:i.toLowerCase()>r.toLowerCase()?1:0});n=$("#appsList");$.each(t,function(t,i){n.append(i)});n.prepend(r);n.prepend(i)}function getDroidScriptApp(n){return new Promise(function(t,i){var r=null;n.charAt(0)!="~"&&n.charAt(0)!="."?NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=list&dir="+encodeURIComponent(n))}).then(function(i){var f=JSON.parse(i).list,e,u;if(f.indexOf(n+".js")!=-1||f.indexOf(n+".html")!=-1)for(r=new DroidScriptApp(n),e=0;e<f.length;++e)isSupportedFileType(f[e])&&(u=new DroidScriptAppFile(f[e]),r.addEditorFile(u),u.displayName.toUpperCase()==n.toUpperCase()?(u.canDelete=!1,r.activeEditorFile=u,r.mainEditorFile=u):u.canDelete=!0);t(r)},i):t(r)})}function newApp(n){n=="js"?$("#newAppDialogTitle").text("New App"):n=="html"?$("#newAppDialogTitle").text("New Html App"):Logger.message("Cannot create app, unknown app type: "+n);var t=function(){var t=$("#newAppDialogAppName").val(),i;containsReservedCharacters(t)?$("#newAppError").fadeIn():($("#newAppDialog").modal("hide"),i="ide?cmd=add&prog="+encodeURIComponent(t)+"&type="+n,NetUtils.ajaxGet({url:NetUtils.getServerUrl(i)}).then(function(){return getDroidScriptApp(t)}).then(function(n){appService.addApp(n);appendAppToAppsList(n);sortAppList();openApp(n)},onRequestError))};$("#newAppDialogButton").off("click").click(t);$("#newAppDialog").modal("show")}function openApp(n){loadEditorFile(n.mainEditorFile,n).then(function(){var i,t;for(appService.getOpenApp()!=null&&appService.getOpenApp().close(),$("#editorTabs").empty(),i=[],t=0;t<n.getEditorFileCount();++t)n.getEditorFile(t)==n.mainEditorFile?$("#editorTabs").prepend(createEditorFileTab(n.getEditorFile(t))):$("#editorTabs").append(createEditorFileTab(n.getEditorFile(t))),i.push(loadEditorFile(n.getEditorFile(t),n));Promise.all(i).then(function(){appService.setOpenApp(n);n.activeEditorFile=n.mainEditorFile;$('ul[id="editorTabs"] a').on("shown",onEditorFileTabChanged);$('#editorTabs a[href="'+n.activeEditorFile.tabId+'"]').tab("show");$('#leftPanelTabs a[href="#editorTab"]').tab("show");refreshAssets();n.getName().substring(0,4)=="SWS-"?($("#runBtn").prop("disabled",!0),$("#stopBtn").prop("disabled",!0)):($("#runBtn").prop("disabled",!1),$("#stopBtn").prop("disabled",!1));$("#editorTabs").tabdrop();editor.resize();chromeApp.onAppOpened(n.getName());chromeApp.getLocalAppChanges(n.getName(),function(t){var i="Restore unsaved changes to the following file(s)?<br>";for(var r in t.files)t.files.hasOwnProperty(r)&&(i+="<strong>"+r+"<\/strong>",i+="<br>");$("#restoreDiscardDialogRestoreButton").off("click").click(function(){for(var i in t.files)if(t.files.hasOwnProperty(i)){function r(n){n!=null&&loadEditorFile(n,t).then(function(){var i=t.files[n.filename];n.session.setValue(i);setModified(n,!0)})}r(n.getEditorFileForFilename(i))}});$("#restoreDiscardDialogDiscardButton").off("click").click(function(){chromeApp.discardLocalAppChanges(n.getName())});$("#restoreDiscardDialogMessage").html(i);$("#restoreDiscardDialog").modal("show")})},onRequestError)},onRequestError)}function onEditorFileTabChanged(n){var i=n.target.getAttribute("href"),t=appService.getOpenApp();t.activeEditorFile=t.getEditorFileForTab(i);loadEditorFile(t.activeEditorFile,t).then(function(){editor.setSession(t.activeEditorFile.session);editor.focus()},function(){if(n.relatedTarget!=null){var t=$('#editorTabs a[href="'+n.relatedTarget.getAttribute("href")+'"]');t.tab("show")}onRequestError()})}function loadEditorFile(n,t){return new Promise(function(i,r){n.session==null?(Debug.Log("loadEditorFile creating session"),NetUtils.ajaxGet({url:NetUtils.getServerUrl(encodeURIComponent(t.folder)+"/"+encodeURIComponent(n.filename)),dataType:"text"}).then(function(t){n.session=t==null||t==""?createEditSession(n.getType(),$("#phoneAppTemplate").text()):createEditSession(n.getType(),t);Debug.Log("session created");i()},r)):(Debug.Log("loadEditorFile session already created"),i())})}function createEditorFileTab(n){var i="",t;return i=n.canDelete?'<li style="position:relative"><a style="padding-right:25px" href="'+n.tabId+'" data-toggle="tab">'+n.filename+'<\/a><button class="close deleteFileBtn" data-toggle="tooltip" data-original-title="Delete"><i class="icon-trash"><\/i><\/button><\/li>':'<li><a href="'+n.tabId+'" data-toggle="tab">'+n.filename+"<\/a><\/li>",t=$(i),t.data("editorFile",n),t}function isSupportedFileType(n){var t=n.toLowerCase();return t.indexOf(".js")!=-1||t.indexOf(".htm")!=-1||t.indexOf(".css")!=-1||t.indexOf(".txt")!=-1||t.indexOf(".json")!=-1?!0:!1}function newFile(n,t){var i,r,u;if(n.trim().length==0){$("#newFileError").html("<b>Emtpy Filename.<\/b> Please enter a filename.");$("#newFileError").fadeIn();return}for(i="",t.toLowerCase().localeCompare("text")==0?n.toLowerCase().indexOf(".txt")==-1&&(n+=".txt"):t.toLowerCase().localeCompare("html")==0?(n.toLowerCase().indexOf(".htm")==-1&&(n+=".html"),i="<html>\n\t<head>\n\t\t<title>Hello World!<\/title>\n\t<\/head>\n\t<body>\n\t\t<p>Hello World!<\/p>\n\t<\/body>\n<\/html>"):t.toLowerCase().localeCompare("css")==0?(n.toLowerCase().indexOf(".css")==-1&&(n+=".css"),i="body\n{\n\n}"):t.toLowerCase().localeCompare("json")==0?(n.toLowerCase().indexOf(".json")==-1&&(n+=".json"),i="{\n\n}"):n.toLowerCase().indexOf(".js")==-1&&(n+=".js"),r=appService.getOpenApp(),u=0;u<r.getEditorFileCount();++u)if(r.getEditorFile(u).filename.toLowerCase()==n.toLowerCase()){$("#newFileError").html("<b>Cannot Create File.<\/b> A file with the name '"+n+"' already exists.");$("#newFileError").fadeIn();return}createFile(appService.getOpenApp().folder,n,i).then(function(){var t=new DroidScriptAppFile(n),u;t.canDelete=!0;t.session=createEditSession(t.getType(),i);r.addEditorFile(t);$("#editorTabs").append(createEditorFileTab(t));$("#editorTabs").data("tabdrop").layout();appService.getOpenApp().activeEditorFile=t;u=$('#editorTabs a[href="'+appService.getOpenApp().activeEditorFile.tabId+'"]');u.on("shown",onEditorFileTabChanged);u.tab("show");$("#newFileDialog").modal("hide")},function(){Logger.message("Failed to create file "+n+". Is DroidScript running and Wi-Fi enabled?")})}function createFile(n,t,i,r){return new Promise(function(u,f){var e=NetUtils.getServerUrl("uploader");typeof r=="undefined"&&(r="text/plain");connect(serverIPAddress).then(function(){var s=new FormData,h=new Blob([i],{type:r}),o;s.append(n,h,t);o=$.ajax({url:e,data:s,cache:!1,contentType:!1,processData:!1,type:"POST"});o.fail(function(n,r){Debug.Log("createFile("+t+", "+i+") failed: "+r);f()});o.done(function(){u()})},f)})}function createEditSession(n,t){var u=new Document(t),i="ace/mode/javascript",r;return n.toLowerCase().indexOf("htm")!=-1?i="ace/mode/html":n.toLowerCase().indexOf("css")!=-1?i="ace/mode/css":n.toLowerCase().indexOf("txt")!=-1?i="ace/mode/text":n.toLowerCase().indexOf("json")!=-1&&(i="ace/mode/json"),r=new EditSession(u,i),r.setUseWorker(!1),r.setUndoManager(new UndoManager),r}function onDocumentChanged(){var n=appService.getOpenApp().activeEditorFile;setModified(n,!0)}function setModified(n,t){if(n.setModified(t),t)chromeApp.onFileModified(n.filename,n.session.getValue());else chromeApp.onFileSaved(n.filename);var i=n.modified?"*"+n.filename:n.filename;$('#editorTabs a[href="'+n.tabId+'"]').text(i);$("#editorTabs").data("tabdrop").layout()}function onTokensChanged(){for(var t,n,e,o,r,f,i=[],s=appService.getOpenApp().activeEditorFile.session.getLength(),u=0;u<=s;++u)for(t=appService.getOpenApp().activeEditorFile.session.getTokens(u),n=0;n<t.length;++n)if(t[n].type=="storage.type"&&t[n].value=="function"){t.length>n+2&&(e=t[n+2],e.type=="entity.name.function"&&i.push({name:e.value,line:u+1}));break}for(i.sort(function(n,t){return n.name.toLowerCase()<t.name.toLowerCase()?-1:n.name.toLowerCase()>t.name.toLowerCase()?1:0}),o="",r=0;r<i.length;++r)f='<li id="'+i[r].line+'">',f+='<a href="#">'+i[r].name+"<\/a>",f+="<\/li>\n",o+=f;$("#functionJumpList").html(o);$("ul[id*=functionJumpList] li").click(function(){editor.gotoLine($(this).attr("id"),0,!0);editor.focus()})}function onCollapseAll(){var n=appService.getOpenApp().activeEditorFile.session;n.foldAll(0,n.getLength(),0)}function onExpandAll(){var n=appService.getOpenApp().activeEditorFile.session,t=new Range(0,0,n.getLength(),0);n.unfold(t,!1)}function containsReservedCharacters(n){return/[|\\?*<\":>\[\]\/']+/.test(n)}function loadExternalImage(n,t,i){t.attr("src",n).on("error",function(){t.attr("src",i)})}function sortList(n){return n.sort(function(n,t){return n.toLowerCase().localeCompare(t.toLowerCase())}),n}function stringToArrayBuffer(n){for(var i=new ArrayBuffer(n.length*2),r=new Uint8Array(i),t=0,u=n.length;t<u;t++)r[t]=n.charCodeAt(t);return i}function arrayBufferToString(n){return String.fromCharCode.apply(null,new Uint8Array(n))}function applyConfig(){editor.setFontSize(ideConfig.getFontSize());editor.setBehavioursEnabled(ideConfig.getUseBehaviours());sampleEditor.setFontSize(ideConfig.getFontSize());appService.getOpenApp()&&appService.getOpenApp().activeEditorFile&&applyConfigForSession(appService.getOpenApp().activeEditorFile.session)}function applyConfigForSession(n){n.$modeId=="ace/mode/javascript"&&n.$worker&&n.$worker.call("changeOptions",[{predef:["app"]}])}var uniqueTabIdCounter,_localStorageId,Debug,webSocketKeepAliveTimer,dragOverStack;DroidScriptApp.prototype.getName=function(){return this.folder};DroidScriptApp.prototype.getIconPath=function(){return this.folder+"/Img/"+this.folder+".png"};DroidScriptApp.prototype.isModified=function(){for(var n=0;n<this.editorFiles.length;++n)if(this.editorFiles[n].modified)return!0;return!1};DroidScriptApp.prototype.getEditorFileCount=function(){return this.editorFiles.length};DroidScriptApp.prototype.indexOf=function(n){return this.editorFiles.indexOf(n)};DroidScriptApp.prototype.getEditorFile=function(n){return this.editorFiles[n]};DroidScriptApp.prototype.addEditorFile=function(n){this.editorFiles.push(n);this.fireFileAdded(n)};DroidScriptApp.prototype.removeEditorFile=function(n){var t=this.editorFiles.indexOf(n);this.editorFiles.splice(t,1);this.fireFileRemoved(n)};DroidScriptApp.prototype.getEditorFileForTab=function(n){for(var t=0;t<this.editorFiles.length;++t)if(this.editorFiles[t].tabId==n)return this.editorFiles[t];return null};DroidScriptApp.prototype.getEditorFileForFilename=function(n){for(var t=0;t<this.editorFiles.length;++t)if(this.editorFiles[t].filename==n)return this.editorFiles[t];return null};DroidScriptApp.prototype.getEditorFileForSession=function(n){for(var t=0;t<this.editorFiles.length;++t)if(this.editorFiles[t].session==n)return this.editorFiles[t];return null};DroidScriptApp.prototype.getEditorFilePath=function(n){return this.folder+"/"+n.filename};DroidScriptApp.prototype.getType=function(){return this.mainEditorFile.getType()};DroidScriptApp.prototype.close=function(){for(var n=0;n<this.editorFiles.length;++n)this.editorFiles[n].close()};DroidScriptApp.prototype.rename=function(n){var t=this;return new Promise(function(i,r){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=rename&file="+encodeURIComponent(t.folder)+"&newname="+encodeURIComponent(n))}).then(function(){t.folder=n;var i=n+"/"+t.mainEditorFile.filename,r=n+"/"+n+"."+t.mainEditorFile.getType();return NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=rename&file="+encodeURIComponent(i)+"&newname="+encodeURIComponent(r))})}).then(function(){t.mainEditorFile.displayName=n;t.mainEditorFile.filename=n+"."+t.mainEditorFile.getType();i()},r)})};DroidScriptApp.prototype.delete=function(){var n=this.getName();return new Promise(function(t,i){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=delete&file="+encodeURIComponent(n))}).then(t,i)})};DroidScriptApp.prototype.on=function(n,t){this.eventHandlers[n].push(t)};DroidScriptApp.prototype.off=function(n,t){this.eventHandlers[n]=eventHandlers[n].filter(function(n){if(n!==t)return n})};DroidScriptApp.prototype.fireFileAdded=function(n){this.eventHandlers.fileAdded.forEach(function(t){t.call(this,n)})};DroidScriptApp.prototype.fireFileRemoved=function(n){this.eventHandlers.fileRemoved.forEach(function(t){t.call(this,n)})};DroidScriptApp.prototype.fireFileRenamed=function(n){this.eventHandlers.fileRenamed.forEach(function(t){t.call(this,n)})};uniqueTabIdCounter=1;DroidScriptAppFile.prototype.setModified=function(n){this.modified=n};DroidScriptAppFile.prototype.getType=function(){var n=this.filename.split(".");return n[n.length-1]};DroidScriptAppFile.prototype.close=function(){this.functions=[];this.session=null;this.modified=!1;this.errorMarkers=[]};_localStorageId="_ideConfig";IDEConfig.prototype.getIPAddress=function(){return this.config.ipAddress};IDEConfig.prototype.setIPAddress=function(n){this.config.ipAddress=n;this.save()};IDEConfig.prototype.getZoom=function(){return this.config.zoom};IDEConfig.prototype.setZoom=function(n){this.config.zoom=n;this.save()};IDEConfig.prototype.getFontSize=function(){return this.config.editor.fontSize};IDEConfig.prototype.setFontSize=function(n){this.config.editor.fontSize=n;this.save()};IDEConfig.prototype.getUseBehaviours=function(){return this.config.useBehaviours};IDEConfig.prototype.setUseBehaviours=function(n){this.config.editor.useBehaviours=n;this.save()};IDEConfig.prototype.getUseWorker=function(){return this.config.useWorker};IDEConfig.prototype.setUseWorker=function(n){this.config.editor.useWorker=n;this.save()};IDEConfig.prototype.load=function(){var n=this;return new Promise(function(t){if(location.protocol=="chrome-extension:")chrome.storage.local.get(["ip","zoom",_localStorageId],function(i){if(i!=null)try{typeof i[_localStorageId]!="undefined"&&(n.config=$.extend(!0,{},n.config,i[_localStorageId]));typeof i.ip=="string"&&(n.config.ip=i.ip,chrome.storage.local.remove("ip"));typeof i.zoom=="string"&&(n.config.zoom=parseFloat(i.zoom),chrome.storage.local.remove("zoom"))}catch(r){console.log("IDEConfig.load error: "+r)}t()});else if(localStorage&&localStorage.getItem(_localStorageId)){try{var i=JSON.parse(localStorage.getItem(_localStorageId));n.config=$.extend(!0,{},n.config,i)}catch(r){console.log("IDEConfig.load error: "+r)}t()}else console.log("IDEConfig not loaded"),t()})};IDEConfig.prototype.save=function(){var n,i;if(location.protocol=="chrome-extension:")try{n={};n[_localStorageId]=this.config;chrome.storage.local.set(n)}catch(t){console.log("IDEConfig.save error: "+t)}else if(localStorage)try{i=JSON.stringify(this.config);localStorage.setItem(_localStorageId,i)}catch(t){console.log("IDEConfig.save error: "+t)}};Debug={set enabled(n){this.Log=n?function(){return console.log.apply(console,arguments)}:function(){}},Log:function(){}};Log.prototype._showItem=function(n){var i=$(n),t=$("#debugFilter").val().trim(),r;t.length>0&&(t=t.replace(/[-\/\\^$*+?.()|[\]{}]/g,"\\$&"),r=new RegExp(t,"i"),r.test(i.text())||i.hide());this.list.append(i);this.scrollToBottom()};Log.prototype.message=function(n){this._showItem("<li class='debug-message'><div class='debug-no-icon'>"+n+"<\/div><\/li>")};Log.prototype.error=function(n){var i=n,t,r;n.indexOf("Script Error:")>-1&&(t=n.split("|"),t.length==3&&(i=t[0].replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;"),r=t[2].replace(/^.*[\\\/]/,""),r.indexOf("~")!=0&&(i+=", Line "+t[1],i+=", "+r)));this._showItem("<li class='debug-error'><div class='debug-error-icon'>"+i+"<\/div><\/li>")};Log.prototype.warning=function(n){this._showItem("<li class='debug-warning'><div class='debug-warning-icon'>"+n+"<\/div><\/li>")};Log.prototype.service=function(n){var t=n.replace("svc:","");this._showItem("<li class='debug-service'><div class='debug-no-icon'>"+t+"<\/div><\/li>")};Log.prototype.clear=function(){this.list.empty()};Log.prototype.scrollToBottom=function(){var n=this.list.outerHeight(!0);this.list.parent().scrollTop(n)};var Resources={APP_ICON:"resources/droidscript_app.png",ASSET_IMG:"resources/image.png",ASSET_SND:"resources/sound.png",ASSET_HTML:"resources/html.png",ASSET_MISC:"resources/file.png",COLLAPSE:"resources/collapse.png",EXPAND:"resources/expand.png"},NetUtils={getUrl:function(n,t){return n+"://"+serverIPAddress+":"+t},getServerUrl:function(n){return NetUtils.getUrl("http",8088)+"/"+n},getServerWSUrl:function(n){return NetUtils.getUrl("ws",8088)+"/"+n},ajaxGet:function(n){return new Promise(function(t,i){simulate?sim_ajaxGet(simulate,n,t,i):connect(serverIPAddress).then(function(){n.cache=!1;var r=$.ajax(n);r.done(function(n){t(n)});r.fail(function(){i()})},i)})},ajaxGetNoConnect:function(n){return new Promise(function(t,i){if(simulate)sim_ajaxGet(simulate,n,t,i);else{n.cache=!1;var r=$.ajax(n);r.done(function(n){t(n)});r.fail(function(){i()})}})}},ds_excludedTypes=["OnCreate"],ds_excludedProperties={SObj:["Destroy","Release"],Obj:["Destroy","Release"],App:["Try","_Extract"],Zip:["CreateKey","CreateDebugKey","Sign","UpdateManifest"],Img:["_auto","_gfb"]},tern_commands={ternShowType:{name:"ternShowType",exec:function(n){n.ternServer.showType(n)},bindKey:"Ctrl-I"}};ChromeApp.prototype.isInitialised=function(){return this.initialised};ChromeApp.prototype.init=function(){this.initialised=!0;localThis=this;chrome.runtime.getPlatformInfo(function(n){n.os=="win"&&localThis._startDiscovery()})};ChromeApp.prototype.getPlatformOS=function(n){chrome.runtime.getPlatformInfo(function(t){n(t.os)})};ChromeApp.prototype.setDeviceId=function(n){this.deviceId=n};ChromeApp.prototype._startDiscovery=function(){this.broadcastSocket=new UDPSocket;var n=this.broadcastSocket;this.broadcastSocket.open(function(){n.setOnReceive(function(n){var t=null,r,i,u;try{t=JSON.parse(arrayBufferToString(n.data));console.log(t)}catch(f){t=null}t!=null&&(console.log(t),r=!1,$("#connectServers").children("a").each(function(){r|=$(this).data("ipAddress")==n.remoteAddress}),r||(i='<a id=\'server\' class="btn btn-flat" style="width: 100%; padding: 0px">',t.usepass&&(i+='<i class="fa fa-lock" style="float: right;margin: 3px"><\/i>'),i+='<p style="margin: 3px 5px 0px 5px; text-align: left; font-size: 14px"><b>'+t.appname+" ("+t.devicename+')<\/b><\/p><p style="margin: 0px 5px 3px 5px; text-align: left; font-size: 12px">'+n.remoteAddress+"<\/p><\/a>",u=$(i),u.data("ipAddress",n.remoteAddress),$("#connectServers").append(u)))});n.sendDiscoverDSSeverRequest();$("#connectServerSection").show()})};ChromeApp.prototype.getLocalStorageString=function(n,t){this.initialised&&chrome.storage.local.get(n,function(i){i!=null&&typeof i[n]=="string"&&t(i[n])})};ChromeApp.prototype.setLocalStorageString=function(n,t){if(this.initialised){var i={};i[n]=t;chrome.storage.local.set(i)}};ChromeApp.prototype.onAppOpened=function(n){if(this.initialised){var t=this.deviceId;chrome.runtime.getBackgroundPage(function(i){i.onAppOpened(n,t)})}};ChromeApp.prototype.onFileModified=function(n,t){this.initialised&&chrome.runtime.getBackgroundPage(function(i){i.onFileModified(n,t)})};ChromeApp.prototype.onFileSaved=function(n){this.initialised&&chrome.runtime.getBackgroundPage(function(t){t.onFileSaved(n)})};ChromeApp.prototype.getLocalAppChanges=function(n,t){if(this.initialised){var i=this.deviceId;chrome.runtime.getBackgroundPage(function(r){r.getLocalAppChanges(n,i,t)})}};ChromeApp.prototype.discardLocalAppChanges=function(n){if(this.initialised){var t=this.deviceId;chrome.runtime.getBackgroundPage(function(i){i.forgetApp(n,t)})}};ChromeApp.prototype.zoom=function(n){$("#pageBody").css("zoom",n);var t=document.getElementById("homeView");t!=null&&t.setZoom(n);t=document.getElementById("docs");t!=null&&t.setZoom(n)};UDPSocket.prototype.open=function(n,t){var i=this;chrome.sockets.udp.create({},function(r){i.socketId=r.socketId;chrome.runtime.getBackgroundPage(function(n){n.setBroadcastSocketId(i.socketId)});chrome.sockets.udp.bind(i.socketId,"0.0.0.0",19800,function(i){if(i<0){console.log("Error binding socket.");t!=null&&t(i);return}n()})})};UDPSocket.prototype.close=function(){this.socketId!=-1&&(chrome.sockets.udp.close(this.socketId),this.socketId=-1,chrome.runtime.getBackgroundPage(function(n){n.setBroadcastSocketId(-1)}))};UDPSocket.prototype.setOnReceive=function(n){chrome.sockets.udp.onReceive.addListener(n)};UDPSocket.prototype.sendDiscoverDSSeverRequest=function(){this.sendBroadcastMessage("DISCOVER_DSSERVER_REQUEST")};UDPSocket.prototype.sendBroadcastMessage=function(n){var t=this;this.getBroadcastAddresses(function(i){var u,r;console.log("BroadcastAddresses: "+i);try{for(u=stringToArrayBuffer(n),r=0;r<i.length;++r)chrome.sockets.udp.send(t.socketId,u,i[r],19800,function(n){console.log(n)})}catch(f){console.log("sendBroadcastMessage: "+f)}})};UDPSocket.prototype.getBroadcastAddresses=function(n){this.getLocalIPAddresses(function(t){var i,r,u;for(console.log(t),i=[],r=0;r<t.length;++r)u=t[r].split("."),u.length==4&&(u[3]=255,broadcastIp=u.join("."),i.indexOf(broadcastIp)==-1&&i.push(broadcastIp));i.length>0&&n(i)})};UDPSocket.prototype.getLocalIPAddresses=function(n){var t=[];chrome.system.network.getNetworkInterfaces(function(i){for(var u,r=0;r<i.length;++r)u=i[r].address.split("."),u.length==4&&t.push(i[r].address);n(t)})};var Range=require("ace/range").Range,Document=require("ace/document").Document,EditSession=require("ace/edit_session").EditSession,UndoManager=require("ace/undomanager").UndoManager,editor,sampleEditor,webSocket,serverIPAddress="",currentSample="",simulate=null,chromeApp=new ChromeApp,serverInfo=null,serverPass="",Logger=null,ideConfig=new IDEConfig,appService=new AppService,ternService=null,busySpinner=null;Debug.enabled=!1;document.addEventListener("DOMContentLoaded",function(){document.body.addEventListener("resize",onEditorResize);document.querySelector("#newBtn").addEventListener("click",function(){$("#newFileError").hide();$("#newFileDialog").modal("show")});document.querySelector("#saveBtn").addEventListener("click",onSave);document.querySelector("#runBtn").addEventListener("click",onRun);document.querySelector("#stopBtn").addEventListener("click",onStop);document.querySelector("#collapseAllBtn").addEventListener("click",onCollapseAll);document.querySelector("#expandAllBtn").addEventListener("click",onExpandAll);document.querySelector("#expBtn").addEventListener("click",onExpand);document.querySelector("#imgUploadBtn").addEventListener("click",function(){$("input[id=imageUploadFile]").click()});document.querySelector("#sndUploadBtn").addEventListener("click",function(){$("input[id=soundUploadFile]").click()});document.querySelector("#htmlUploadBtn").addEventListener("click",function(){$("input[id=htmlUploadFile]").click()});document.querySelector("#miscUploadBtn").addEventListener("click",function(){$("input[id=miscUploadFile]").click()});document.querySelector("#reloadHomeBtn").addEventListener("click",loadHomePage);document.querySelector("#sampleBackBtn").addEventListener("click",function(){$("#sampleCodeView").hide();$("#sampleContentView").show()});document.querySelector("#sampleRunBtn").addEventListener("click",runSample);document.querySelector("#sampleStopBtn").addEventListener("click",onStop);document.querySelector("#sampleFilterClearBtn").addEventListener("click",function(){$("#sampleFilter").val("")});document.querySelector("#debugClearBtn").addEventListener("click",function(){Logger.clear()});document.querySelector("#connectButton").addEventListener("click",onConnect);document.querySelector("#connectRefreshServerButton").addEventListener("click",function(){chromeApp.broadcastSocket!=null&&($("#connectServers").empty(),chromeApp.broadcastSocket.sendDiscoverDSSeverRequest())});document.querySelector("#newFileDialogButton").addEventListener("click",function(){newFile($("#fileName").val(),$("#fileTypeChoice").html())});document.querySelector("#sampleFilter").addEventListener("change",onSampleFilter);document.querySelector("#sampleFilter").addEventListener("keypress",onSampleFilter);document.querySelector("#sampleFilter").addEventListener("paste",onSampleFilter);document.querySelector("#sampleFilter").addEventListener("input",onSampleFilter);document.querySelector("#sampleFilterClearBtn").addEventListener("click",function(){$("#sampleFilter").val("");onSampleFilter()});$("#sampleFilterForm").submit(function(){return!1});document.querySelector("#debugFilter").addEventListener("change",onDebugFilter);document.querySelector("#debugFilter").addEventListener("keypress",onDebugFilter);document.querySelector("#debugFilter").addEventListener("paste",onDebugFilter);document.querySelector("#debugFilter").addEventListener("input",onDebugFilter);document.querySelector("#debugFilterClearBtn").addEventListener("click",function(){$("#debugFilter").val("");onDebugFilter()});$("#debugFilterForm").submit(function(){return!1});$(".modal-with-form").on("shown",function(){$(this).find(".focus-input").focus()});$(".modal-form").submit(function(n){n.preventDefault()});$(".asset-drop-target").on("dragover",handleAssetDragOver);$(".asset-drop-target").on("drop",handleAssetDrop);$(".asset-drop-target").on("dragenter",handleAssetDragEnter);$(".asset-drop-target").on("dragleave",handleAssetDragLeave);$(".asset-drop-target").on("dragend",handleAssetDragEnd)});$(document).ready(function(){var n;Logger=new Log($("#debugList"),$("#debugFilter"));location.protocol=="chrome-extension:"&&navigator.appVersion.indexOf("CrOS")!=-1&&($("#topNavBar").hide(),$("#pageContentWrapper").css("top",0));$("#topNavBar").is(":visible")&&(n=$("#topNavBar").outerHeight(!0),$("#pageContentWrapper").css("top",n));$(document).ajaxStart(function(){busySpinner.show()}).ajaxStop(function(){busySpinner.hide()});var t=document.getElementById("busySpinner"),i=new Spinner({lines:11,length:20,width:9,radius:30,corners:1,rotate:0,direction:1,color:"#000",speed:1,trail:60,shadow:!0,hwaccel:!0,className:"spinner",zIndex:2e9,top:"auto",left:"auto"}).spin(t);busySpinner=new ElementFader($("#busyOverlay"));ideConfig.load().then(function(){var n,t,i;if(initIDE(),location.protocol=="http:")if(/^(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)\.(25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)$/.test(location.hostname)){function r(n){if(n==5){onRequestError();return}connect(location.hostname).then(function(n){connected(n)},function(t){t=="PasswordError"?($("#passwordDialogError").show(),r(++n)):onRequestError()})}$("#passwordDialogCancelButton").hide();r(0)}else $("#serverIPAddress").val(ideConfig.getIPAddress()),$("#connectDialog").modal("show");else location.protocol=="file:"?location.href.toLowerCase().indexOf("smartscript")<0?($("#serverIPAddress").val(ideConfig.getIPAddress()),$("#connectDialog").modal("show")):(simulate="SmartScript",connect("file")):location.protocol=="chrome-extension:"?(chromeApp.init(),chromeApp.zoom(ideConfig.getZoom()),$("#serverIPAddress").val(ideConfig.getIPAddress()),$("#connectDialog").modal("show")):Debug.Log("Unable to determine where IDE is running from: "+document.URL);n=$("#rightPanelTabs").outerHeight(!0);$(".homeWrapper").css("top",n);$(".samplesWrapper").css("top",n);$(".docsWrapper").css("top",n);$(".debugWrapper").css("top",n);updateTooltips();onEditorResize();$("#newAppDialog").on("hidden",function(){$("#newAppError").hide()});$("#renameDialog").on("hidden",function(){$("#renameError").hide()});chromeApp.isInitialised()?(i=$("<webview id='homeView' src=''><\/webview>"),i.appendTo(".homeWrapper"),t=document.getElementById("homeView"),t.addEventListener("loadstop",function(){clearTimeout(homePageErrorTimeout);t.clearData({since:0},{appcache:!0,cache:!0},function(){Debug.Log("cache cleared")});$("#homeView").css("width","100%");$("#homeView").css("height","100%");$("#homeErrorPage").hide();window.addEventListener("message",onReceiveMessage);t.addEventListener("newwindow",function(n){n.preventDefault();window.open(event.targetUrl)});t.contentWindow.postMessage({command:"handshake"},"*")})):(i=$("<iframe id='homeView' src='' frameborder='0'><\/iframe>"),i.appendTo(".homeWrapper"),window.addEventListener("message",onReceiveMessage));homePageErrorTimeout=setTimeout(function(){$("#homeErrorPage").show()},5e3);loadHomePage()})});document.addEventListener("keydown",function(n){var i=navigator.platform.match("Mac")?n.metaKey:n.ctrlKey,t;n.keyCode==83&&i?(n.preventDefault(),onSave()):n.keyCode==78&&i?(n.preventDefault(),onSave()):n.keyCode==82&&n.altKey?(n.preventDefault(),onRun()):n.keyCode==83&&n.altKey?(n.preventDefault(),onStop()):n.keyCode==116||n.keyCode==82&&i?$("#appsTab").is(":visible")&&(n.preventDefault(),refreshAppsList()):n.keyCode==187&&i?chromeApp.isInitialised()&&(n.preventDefault(),t=parseFloat($("#pageBody").css("zoom")),t=parseFloat(t.toFixed(1)),t+=.1,chromeApp.zoom(t),ideConfig.setZoom(t)):n.keyCode==189&&i&&chromeApp.isInitialised()&&(n.preventDefault(),t=parseFloat($("#pageBody").css("zoom")),t=parseFloat(t.toFixed(1)),t-=.1,t<.1&&(t=.1),chromeApp.zoom(t),ideConfig.setZoom(t))},!1);window.onbeforeunload=function(){return"Any unsaved changes will be lost."};$(document).on("click","#server",function(){var n=$(this).data("ipAddress");$("#serverIPAddress").val(n)});$(".immediate-form").on("submit",function(){var n=$("#immediate-code").val();return n.trim()!=""&&NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=exec&code="+encodeURIComponent(n))}),!1});webSocketKeepAliveTimer=null;$(document).on("click","#deleteAssetButton",function(){$(".tooltip").hide();var n=$(this).closest("li"),t=n.data("assetFile"),i=n.data("assetDir");typeof t!="undefined"&&typeof i!="undefined"&&($("#okCancelDialogOkButton").off("click").click(function(){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=delete&file="+encodeURIComponent(i+"/"+t))}).then(function(){n.remove()})}),$("#okCancelDialogHeader").text("Delete Asset"),$("#okCancelDialogMessage").text("Are you sure you want to delete '"+t+"'?"),$("#okCancelDialog").modal("show"))});$(document).on("click","#renameAssetButton",function(){var n=$(this).closest("li"),t=n.data("assetFile"),i=n.data("assetDir"),r;typeof t!="undefined"&&typeof i!="undefined"&&($("#renameDialogName").val(t),r=function(){if($("#renameDialogName").val()!="")if(containsReservedCharacters($("#renameDialogName").val()))$("#renameError").fadeIn();else{var r=i+"/"+t,u=i+"/"+$("#renameDialogName").val();$("#renameDialog").modal("hide");NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=rename&file="+encodeURIComponent(r)+"&newname="+encodeURIComponent(u))}).then(function(){var t,i;n.find("div.thumbnailFilename").text($("#renameDialogName").val());n.data("assetFile",$("#renameDialogName").val());t=n.closest("ul").find("li");t.sort(function(n,t){var i=$(n).data("assetFile"),r=$(t).data("assetFile");return i.toLowerCase()<r.toLowerCase()?-1:i.toLowerCase()>r.toLowerCase()?1:0});i=n.closest("ul");$.each(t,function(n,t){i.append(t)})})}},$("#renameDialogButton").off("click").click(r),$("#renameDialog").modal("show"))});$("input[id=imageUploadFile]").change(function(){assetFileUploadChanged("imageUploadFile","imageUploadForm","/Img")});$("input[id=soundUploadFile]").change(function(){assetFileUploadChanged("soundUploadFile","soundUploadForm","/Snd")});$("input[id=htmlUploadFile]").change(function(){assetFileUploadChanged("htmlUploadFile","htmlUploadForm","/Html")});$("input[id=miscUploadFile]").change(function(){assetFileUploadChanged("miscUploadFile","miscUploadForm","/Misc")});dragOverStack=[];$(document).on("click","#sampleButton",function(){var n=$(this).closest("div"),t=n.data("title"),u=n.data("type"),i,r;currentSample=t;i=u=="h"?".html":".js";r=t.split(" ").join("_")+i;NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=get&file=/assets/samples/"+r)}).then(function(n){var t=n.replace(/\\\'/g,""),i;t=JSON.parse(t).file;sampleEditor.setValue(t);sampleEditor.moveCursorTo(0,0);$("#sampleCodeView").show();i=$("#sampleToolBar").outerHeight(!0);$("#sampleEditor").css("top",i);$("#sampleContentView").hide()})});$(document).on("click","#newApp .thumbnail",function(){newApp("js")});$(document).on("click","#newHtmlApp .thumbnail",function(){newApp("html")});$(document).on("click","#openAppButton",function(){var i=$(this).closest("li"),t=i.data("appName"),n;if(t){if(n=appService.getApp(t),appService.getOpenApp()==n){$('#leftPanelTabs a[href="#editorTab"]').tab("show");return}appService.getOpenApp()!=null&&appService.getOpenApp().isModified()?($("#yesNoCancelDialogHeader").text("Unsaved Changes"),$("#yesNoCancelDialogMessage").text("There are unsaved changes, do you want to save changes before continuing?"),$("#yesNoCancelDialogYesButton").off("click").click(function(){saveAll().then(function(){openApp(n)})}),$("#yesNoCancelDialogNoButton").off("click").click(function(){chromeApp.discardLocalAppChanges(appService.getOpenApp().getName());openApp(n)}),$("#yesNoCancelDialog").modal("show")):openApp(n)}});$(document).on("click","#renameAppButton",function(){var n=$(this).closest("li"),t=n.data("appName"),i;t&&($("#renameDialogName").val(t),i=function(){var u,r,i,f;if($("#renameDialogName").val()!=""){if(u=t,r=$("#renameDialogName").val(),containsReservedCharacters(r)){$("#renameError").fadeIn();return}if($("#renameDialog").modal("hide"),r==u)return;typeof appService.getApp(r)!="undefined"?($("#messageDialogHeader").text("Cannot Rename App"),$("#messageDialogMessage").text("An App with the name '"+r+"' already exists."),$("#messageDialog").modal("show")):(i=appService.getApp(t),f=appService.getOpenApp()==i,i.rename(r).then(function(){appService.removeApp(u);appService.addApp(i);n.data("appName",r);f&&($('#editorTabs a[href="'+i.mainEditorFile.tabId+'"]').text(i.mainEditorFile.filename),appService.setOpenApp(i));n.find("p.appFilename").text(i.getName());loadExternalImage(NetUtils.getServerUrl(i.getIconPath()),n.find("img.app-image"),Resources.APP_ICON);sortAppList()},function(){$("#errorDialog").modal("hide")}))}else $("#renameDialog").modal("hide")},$("#renameDialogButton").off("click").click(i),$("#renameDialog").modal("show"))});$(document).on("click","#deleteAppButton",function(){var i=$(this).closest("li"),n=i.data("appName"),t;n&&(t=appService.getApp(n),appService.getOpenApp()==t?($("#messageDialogHeader").text("Cannot Delete App"),$("#messageDialogMessage").text("'"+n+"' is currently open for edit and cannot be deleted."),$("#messageDialog").modal("show")):($("#okCancelDialogOkButton").off("click").click(function(){t.delete().then(function(){i.remove()})}),$("#okCancelDialogHeader").text("Delete App"),$("#okCancelDialogMessage").text("Are you sure you want to delete the App '"+n+"' and all its assets?"),$("#okCancelDialog").modal("show")))});$(document).on("click",".deleteFileBtn",function(){var r=$(this).closest("li"),n=r.data("editorFile"),t,i;typeof n!="undefined"&&(t=appService.getOpenApp(),i=function(){NetUtils.ajaxGet({url:NetUtils.getServerUrl("ide?cmd=delete&file="+encodeURIComponent(t.folder+"/"+n.filename))}).then(function(){var i=t.indexOf(n);t.removeEditorFile(n);$('#editorTabs a[href="'+n.tabId+'"]').parent().remove();$("#editorTabs").data("tabdrop").layout();t.activeEditorFile===n&&(i>=t.getEditorFileCount()&&--i,$('#editorTabs a[href="'+t.getEditorFile(i).tabId+'"]').tab("show"))})},$("#okCancelDialogHeader").text("Delete File"),$("#okCancelDialogMessage").text("Delete '"+n.filename+"', are you sure?"),$("#okCancelDialogOkButton").off("click").click(i),$("#okCancelDialog").modal("show"))});$("#fileTypeOptions li a").click(function(){var n=$(this).text();$("#fileTypeChoice").html(n)})